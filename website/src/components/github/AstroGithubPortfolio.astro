---
import { fetchGitHubPortfolioData, type GitHubRepo } from "./github_utility";

interface Props {
  username?: string;
  maxRepos?: number;
}

const { username = "MiguelMatos98", maxRepos = 6 } = Astro.props;

const data = await fetchGitHubPortfolioData(username);
const displayRepos = data.repos.slice(0, maxRepos);

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString("en-US", {
    month: "short",
    year: "numeric",
  });
}

function getLanguageColor(language: string): string {
  const colors: Record<string, string> = {
    TypeScript: "#3178c6",
    JavaScript: "#f1e05a",
    Python: "#3572A5",
    Rust: "#dea584",
    Go: "#00ADD8",
    Java: "#b07219",
    "C#": "#178600",
    "C++": "#f34b7d",
    C: "#555555",
    HTML: "#e34c26",
    CSS: "#563d7c",
    Shell: "#89e051",
    Ruby: "#701516",
    PHP: "#4F5D95",
    Swift: "#F05138",
    Kotlin: "#A97BFF",
    Dart: "#00B4AB",
    Vue: "#41b883",
    Astro: "#ff5a03",
  };
  return colors[language] || "#8b949e";
}
---

<div class="github-portfolio not-content">
  <!-- Profile Header -->
  <div class="profile-header animate-slide-in" style="--delay: 0">
    <img src={data.user.avatar_url} alt={data.user.name || data.user.login} class="avatar" />
    <div class="profile-info">
      <h2 class="profile-name">{data.user.name || data.user.login}</h2>
      <a href={data.user.html_url} target="_blank" rel="noopener noreferrer" class="profile-link">
        @{data.user.login}
      </a>
      {data.user.bio && <p class="profile-bio">{data.user.bio}</p>}
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-grid animate-slide-in" style="--delay: 1">
    <div class="stat-card">
      <span class="stat-value">{data.user.public_repos}</span>
      <span class="stat-label">Repositories</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">{data.totalStars}</span>
      <span class="stat-label">Total Stars</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">{data.user.followers}</span>
      <span class="stat-label">Followers</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">{data.topLanguages.length}</span>
      <span class="stat-label">Languages</span>
    </div>
  </div>

  <!-- Top Languages -->
  {data.topLanguages.length > 0 && (
    <div class="languages-section animate-slide-in" style="--delay: 2">
      <h3>Top Languages</h3>
      <div class="languages-list">
        {data.topLanguages.slice(0, 8).map((lang, i) => (
          <span class="language-tag animate-pop-in" style={`--lang-color: ${getLanguageColor(lang.name)}; --pop-delay: ${i}`}>
            <span class="language-dot" />
            {lang.name}
            <span class="language-count">{lang.count}</span>
          </span>
        ))}
      </div>
    </div>
  )}

  <!-- Repositories -->
  <div class="repos-section animate-slide-in" style="--delay: 3">
    <h3>Featured Repositories</h3>
    <div class="repos-grid">
      {displayRepos.map((repo: GitHubRepo, i) => (
        <a href={repo.html_url} target="_blank" rel="noopener noreferrer" class="repo-card animate-fade-up" style={`--fade-delay: ${i}`}>
          <div class="repo-header">
            <svg class="repo-icon" viewBox="0 0 16 16" fill="currentColor">
              <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z" />
            </svg>
            <span class="repo-name">{repo.name}</span>
          </div>
          {repo.description && <p class="repo-description">{repo.description}</p>}
          <div class="repo-meta">
            {repo.language && (
              <span class="repo-language" style={`--lang-color: ${getLanguageColor(repo.language)}`}>
                <span class="language-dot" />
                {repo.language}
              </span>
            )}
            {repo.stargazers_count > 0 && (
              <span class="repo-stars">
                <svg viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z" />
                </svg>
                {repo.stargazers_count}
              </span>
            )}
            {repo.forks_count > 0 && (
              <span class="repo-forks">
                <svg viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z" />
                </svg>
                {repo.forks_count}
              </span>
            )}
            <span class="repo-updated">Updated {formatDate(repo.pushed_at)}</span>
          </div>
        </a>
      ))}
    </div>
  </div>

  <!-- View All Link -->
  <div class="view-all animate-slide-in" style="--delay: 4">
    <a href={data.user.html_url} target="_blank" rel="noopener noreferrer" class="view-all-link">
      View all repositories on GitHub
      <span class="arrow">â†’</span>
    </a>
  </div>
</div>

<style>
  /* Keyframe Animations */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes popIn {
    0% {
      opacity: 0;
      transform: scale(0.8);
    }
    70% {
      transform: scale(1.05);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes pulse {
    0%, 100% {
      box-shadow: 0 0 0 0 var(--sl-color-accent);
    }
    50% {
      box-shadow: 0 0 0 4px transparent;
    }
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }

  /* Animation Classes */
  .animate-slide-in {
    opacity: 0;
    animation: slideIn 0.5s ease-out forwards;
    animation-delay: calc(var(--delay, 0) * 0.1s);
  }

  .animate-fade-up {
    opacity: 0;
    animation: fadeUp 0.4s ease-out forwards;
    animation-delay: calc(0.3s + var(--fade-delay, 0) * 0.08s);
  }

  .animate-pop-in {
    opacity: 0;
    animation: popIn 0.3s ease-out forwards;
    animation-delay: calc(0.2s + var(--pop-delay, 0) * 0.05s);
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .animate-slide-in,
    .animate-fade-up,
    .animate-pop-in {
      animation: none;
      opacity: 1;
    }
  }

  .github-portfolio {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .profile-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 2px solid var(--sl-color-gray-5);
    transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .avatar:hover {
    transform: scale(1.08);
    border-color: var(--sl-color-accent);
    box-shadow: 0 0 20px color-mix(in srgb, var(--sl-color-accent) 30%, transparent);
  }

  .profile-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .profile-name {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .profile-link {
    color: var(--sl-color-accent);
    text-decoration: none;
    font-size: 0.95rem;
  }

  .profile-link:hover {
    text-decoration: underline;
  }

  .profile-bio {
    margin: 0.5rem 0 0;
    color: var(--sl-color-gray-2);
    font-size: 0.95rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  @media (max-width: 640px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .stat-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    background: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-4px);
    border-color: var(--sl-color-accent);
    box-shadow: 0 8px 24px -8px color-mix(in srgb, var(--sl-color-accent) 20%, transparent);
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--sl-color-white);
    transition: color 0.2s ease;
  }

  .stat-card:hover .stat-value {
    color: var(--sl-color-accent);
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--sl-color-gray-2);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .languages-section h3,
  .repos-section h3 {
    margin: 0 0 1rem;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .languages-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .language-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    background: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 2rem;
    font-size: 0.85rem;
    color: var(--sl-color-white);
    cursor: default;
    transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
  }

  .language-tag:hover {
    transform: translateY(-2px);
    border-color: var(--lang-color);
    background: color-mix(in srgb, var(--lang-color) 10%, var(--sl-color-gray-6));
  }

  .language-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--lang-color);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .language-tag:hover .language-dot {
    transform: scale(1.2);
    box-shadow: 0 0 8px var(--lang-color);
  }

  .language-count {
    color: var(--sl-color-gray-2);
    font-size: 0.75rem;
  }

  .repos-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (max-width: 768px) {
    .repos-grid {
      grid-template-columns: 1fr;
    }
  }

  .repo-card {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    background: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
  }

  .repo-card:hover {
    transform: translateY(-6px);
    border-color: var(--sl-color-accent);
    box-shadow: 0 12px 32px -12px color-mix(in srgb, var(--sl-color-accent) 25%, transparent);
    background: color-mix(in srgb, var(--sl-color-accent) 3%, var(--sl-color-gray-6));
  }

  .repo-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .repo-icon {
    width: 16px;
    height: 16px;
    color: var(--sl-color-gray-2);
    flex-shrink: 0;
    transition: color 0.2s ease, transform 0.2s ease;
  }

  .repo-card:hover .repo-icon {
    color: var(--sl-color-accent);
    transform: rotate(-5deg);
  }

  .repo-name {
    font-weight: 600;
    color: var(--sl-color-accent);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: letter-spacing 0.2s ease;
  }

  .repo-card:hover .repo-name {
    letter-spacing: 0.02em;
  }

  .repo-description {
    margin: 0 0 auto;
    padding-bottom: 0.75rem;
    font-size: 0.85rem;
    color: var(--sl-color-gray-2);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .repo-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--sl-color-gray-2);
  }

  .repo-language {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  .repo-stars,
  .repo-forks {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .repo-stars svg,
  .repo-forks svg {
    width: 14px;
    height: 14px;
  }

  .repo-updated {
    margin-left: auto;
  }

  .view-all {
    text-align: center;
  }

  .view-all-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    color: var(--sl-color-accent);
    font-weight: 500;
    text-decoration: none;
    border: 1px solid var(--sl-color-accent);
    border-radius: 0.5rem;
    transition: background 0.25s ease, color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
    position: relative;
    overflow: hidden;
  }

  .view-all-link::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent,
      color-mix(in srgb, var(--sl-color-accent) 20%, transparent),
      transparent
    );
    transform: translateX(-100%);
    transition: transform 0.5s ease;
  }

  .view-all-link:hover::before {
    transform: translateX(100%);
  }

  .view-all-link:hover {
    background: var(--sl-color-accent);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px -8px var(--sl-color-accent);
  }

  .view-all-link .arrow {
    display: inline-block;
    transition: transform 0.25s ease;
  }

  .view-all-link:hover .arrow {
    transform: translateX(4px);
  }

  /* Star hover effect for repo cards */
  .repo-stars svg {
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .repo-card:hover .repo-stars svg {
    color: #fbbf24;
    transform: scale(1.15) rotate(10deg);
  }
</style>
